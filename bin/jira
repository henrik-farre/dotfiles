#!/bin/bash

# Fix common errors:
# Referencing undefined variables (which default to "")
# Ignoring failing commands
set -o nounset
set -o errexit
set -o pipefail
# set -o xtrace
# Note this breaks passing a variable as args to a command
IFS=$'\n\t'

source ~/.config/jira_issue.sh

COMMAND=$(basename $0)

case $COMMAND in
    jira_get)
        ISSUE=${1:-}

        curl -s -u "${JIRA_USER}:${JIRA_PASSWORD}" "https://${JIRA_HOST}.atlassian.net/rest/api/2/issue/${ISSUE}" | jq .
        ;;
    jira_transition)
        ISSUE=${1:-}
        OUTPUT=$(curl -s -u "${JIRA_USER}:${JIRA_PASSWORD}" "https://${JIRA_HOST}.atlassian.net/rest/api/2/issue/${ISSUE}")
        CURRENT_TRANS=$(echo "$OUTPUT" | jq -r ".fields.status.id" )

        case "${CURRENT_TRANS}" in
            # Oops
            111)
                TRANSITION_ID=11
                ;;
            # Backlog
            10808)
                echo "=> Klar til visitering"
                TRANSITION_ID=11
                ;;
            # Visiteres
            12400)
                echo "=> Visiteret"
                TRANSITION_ID=31
                ;;
            12402)
                echo "=> Analyse"
                TRANSITION_ID=41
                ;;
            12403)
                echo "=> Ready"
                TRANSITION_ID=51
                ;;
            11900)
                echo "=> In progress"
                TRANSITION_ID=61
                ;;
            10809)
                echo "=> Deploying"
                TRANSITION_ID=71
                ;;
            12404)
                echo "=> Done"
                TRANSITION_ID=91
                ;;
            *)
                echo "Unknown transition: $CURRENT_TRANS"
                exit 1
                ;;
        esac

        DATA=$(printf '{"transition": {"id": "%d"}}' "$TRANSITION_ID")
        curl -s -u "${JIRA_USER}:${JIRA_PASSWORD}" -X POST --data "$DATA" -H "Content-Type: application/json" "https://${JIRA_HOST}.atlassian.net/rest/api/2/issue/${ISSUE}/transitions" | jq .
        ;;
    jira_create)
        SUMMARY=${1:-}
        DESC=${2:-TODO}
        LABELS=${3:-}

        if [[ -z $SUMMARY ]]; then
            echo "Usage:"
            echo "$0 'Summary' 'Description'"
            exit 1
        fi

        FORMATED_LABELS=''
        if [[ ! -z $LABELS ]]; then
            if [ -z "${LABELS##*,*}" ]; then
                LABELS=(${LABELS//,/\", \"})
            fi
            FORMATED_LABELS=$(printf ', "labels": ["%s"]' $LABELS)
        fi

        DATA=$(printf '{"fields":{"project":{"key": "%s"},"summary": "%s","description": "%s","issuetype": {"name": "Task"}%s}}' "$PROJECT_KEY" "$SUMMARY" "$DESC" "$FORMATED_LABELS")

        curl -s -u "${JIRA_USER}:${JIRA_PASSWORD}" -X POST --data "$DATA" -H "Content-Type: application/json" "https://${JIRA_HOST}.atlassian.net/rest/api/2/issue/" | jq .
        ;;
    *)
        echo "Unknown command $COMMAND"
        exit 1
        ;;
esac
