#!/bin/bash
#set -o xtrace

MAX_TRIES=6
TRY=1

export DISPLAY=:0.0
export SSH_AUTH_SOCK="/run/user/$UID/keyring/ssh"

while [ ! -S "$SSH_AUTH_SOCK"  ]
do
    if [ "$TRY" -ge "$MAX_TRIES" ]; then
        echo "Exceeded max tries"
        /usr/bin/notify-send -u low -i "emblem-important" "GIT repositories" "Not updated!" -t 1000000
        exit 1
    fi
    TRY=$((TRY + 1))
    echo "Waiting for socket"
    inotifywait -qqt 2 -e create -e moved_to "$(dirname $SSH_AUTH_SOCK)"
done

GIT_REPOSITORIES=(
    "$HOME/Documents/Zim"
    "$HOME/.config/nvim"
    "$HOME/.dotfiles"
)

if nm-online -q; then
    for DIR in "${GIT_REPOSITORIES[@]}"; do
        (
        cd "$DIR" || exit
        echo "updating $DIR"
        git pull -q
        )
    done
fi

/usr/bin/notify-send -u low -i "emblem-generic" "GIT repositories updated" "... yeah" -t 1000000
