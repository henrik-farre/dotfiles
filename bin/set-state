#!/bin/bash

if [[ -z $1 ]]; then
  echo "Missing arg"
  exit 1
fi

function cpupowersave {
  sudo cpupower frequency-set -g powersave
  return 0
}

function cpuondemand {
  sudo cpupower frequency-set -g ondemand
  return 0
}

function cpuperformance {
  sudo cpupower frequency-set -g performance
  return 0
}

function backlight_control {
  if [[ $1 == 'on' ]]; then
    xbacklight -set 50
  else
    xbacklight -set 100
  fi
}

function powertop_control {
  if [[ -e /usr/bin/powertop ]]; then
    sudo powertop --auto-tune
  fi
}

function pstate_control {
  if [[ $1 == 'off' ]]; then
    sudo sh -c "echo 1 > /sys/devices/system/cpu/intel_pstate/no_turbo"
    sudo sh -c "echo 25 > /sys/devices/system/cpu/intel_pstate/max_perf_pct"
  else
    sudo sh -c "echo 0 > /sys/devices/system/cpu/intel_pstate/no_turbo"
    sudo sh -c "echo 100 > /sys/devices/system/cpu/intel_pstate/max_perf_pct"
  fi
}

function servicesstop {
  return 0
  #pkill dropboxd
  #pkill synergyc
  #systemctl --user stop conky
  #systemctl --user stop syncthing
  #systemctl --user stop syncthing-inotify
}

function servicesstart {
  return 0
  #systemctl --user start syncthing
  #systemctl --user start syncthing-inotify
  #systemctl --user start conky
}

function modulesunload {
 if [[ $HOST == 'ectoplasma' ]]; then
  sudo -i sh -c "rmmod v4l2_common; rmmod ssb; rmmod pcmcia; rmmod pcmcia_core; rmmod uvcvideo; rmmod videobuf2_core; rmmod videodev; rmmod videobuf2_vmalloc; rmmod videobuf2_memops; rmmod btusb; rmmod parport_pc; rmmod ppdev; rmmod parport; rmmod joydev; rmmod bluetooth; rmmod e1000e; rmmod sr_mod; rmmod cdrom; rmmod firewire_ohci; rmmod firewire_core; rmmod hp-wmi"
 fi
}

function nvidiaperformance {
  if [[ -f /usr/bin/nvidia-settings ]]; then
    nvidia-settings -a [gpu:0]/GPUPowerMizerMode=1
  fi
}

function nvidiaadaptive {
  if [[ -f /usr/bin/nvidia-settings ]]; then
    nvidia-settings -a [gpu:0]/GPUPowerMizerMode=0
  fi
}

function disablealt {
  return 0
  # xfconf-query -c xfwm4 -p /general/easy_click -n -t string -s "Ingen"
}

function enablealt {
  return 0
  # xfconf-query -c xfwm4 -p /general/easy_click -n -t string -s "Alt"
}

function screensetup_single {
  xrandr --output DVI-I-1 --off
}

function screensetup_dual {
  xrandr --output DVI-I-1 --auto
  xrandr --output DVI-I-1 --right-of HDMI-0
}

function conky_reload {
   pkill -HUP conky || true
}

MODE=$1

case $MODE in
  powersave)
    cpupowersave
    backlight_control on
    pstate_control off
    powertop_control
    servicesstop
    nvidiaadaptive
    modulesunload
    ;;
  # ondemand)
    # cpuondemand
    # nvidiaadaptive
    # servicesstart
    # ;;
  performance)
    cpuperformance
    servicesstart
    powertop_control
    pstate_control on
    backlight_control off
    ;;
  cpu_turbo_allow)
    pstate_control on
    ;;
  gameon)
    screensetup_single
    disablealt
    cpuperformance
    servicesstop
    nvidiaperformance
    conky_reload
    ;;
  gameoff)
    screensetup_dual
    enablealt
    # cpuondemand
    cpupowersave
    servicesstart
    nvidiaadaptive
    conky_reload
   ;;
 vga-right)
   xrandr --output VGA1 --auto
   xrandr --output VGA1 --right-of LVDS1
   ;;
 laptop-screen-only)
   xrandr --output HDMI1 --off
   xrandr --output LVDS1 --auto
   xrandr --output HDMI2 --off
   xfconf-query -c xfce4-panel -p "/panels/panel-0/output-name" -s "LVDS1"
   ;;
 laptop-screen-dual)
   xrandr --output HDMI1 --auto
   xrandr --output LVDS1 --off
   xrandr --output HDMI2 --auto
   xrandr --output HDMI2 --right-of HDMI1
   ;;
 macbook-hidpi-on)
   gsettings set org.cinnamon panels-height "['1:28']"
   sleep 1
   gsettings set org.cinnamon.desktop.interface scaling-factor "uint32 2"
   sleep 1
   gsettings set org.cinnamon active-display-scale "2"
   sleep 1
   gsettings set org.cinnamon.desktop.interface text-scaling-factor "0.75"
   sleep 1
   conky_reload
   ;;
 macbook-hidpi-off)
   gsettings set org.cinnamon panels-height "['1:34']"
   sleep 1
   gsettings set org.cinnamon.desktop.interface scaling-factor "uint32 1"
   sleep 1
   gsettings set org.cinnamon active-display-scale "1"
   sleep 1
   gsettings set org.cinnamon.desktop.interface text-scaling-factor "1"
   sleep 1
   conky_reload
   ;;
 wacom-setup)
   DEVICE_ID=$(xsetwacom --list devices | awk '{if ($9 == "STYLUS") print $7}')
   xsetwacom --set "$DEVICE_ID" MapToOutput "1920x1200+0+0"
   ;;
 *)
   echo "Unknown mode"
   ;;
esac
